---
title: "Predictors of frog survival following translocations - supplemental analyses"
author: "Roland Knapp"
output: html_notebook
---

The supplemental analyses in this notebook provide additional details to analyses in `translocation_survival_analysis.Rmd`. 

## Load packages

```{r load-packages}
library(tidyverse)
library(brms)
library(rstanarm)
library(bayesplot)
library(tidybayes)
library(loo)
library(broom.mixed)
library(janitor)

source("classification_summary.R")
```


## Evaluate effect of frog size independent of donor population: Model m1d from `translocation_survival_analysis.Rmd` but using data subset where donor = 72996

### Read in frog translocation dataset  
* Read in data, create variables for analysis, standardize continuous variables. 
* arm package used to rescale continuous variables (substract mean, divide by 2 SD), manual centering of binary variables.
```{r read-translocation-data}
d1 <- read_csv(here::here("data", "clean", "frog_translocation_final.csv")) %>% 
  drop_na(bd_load) %>%  # drop 12 records where bd_load is NA (9 are from 70413)
  mutate(
    first = if_else(order == 1, 1, 0),
    surv = if_else(survival < 0.5, 0, 1),
    male = if_else(sex == "m", 1, 0),
    elev_lo = if_else(elevation < 3020, 1, 0), # using interval defined by cut_interval, n = 2
    elev_z = arm::rescale(elevation),
    snowt_z = arm::rescale(snow_t),
    snowt1_z = arm::rescale(snow_t1),
    day_z = arm::rescale(day),
    length_z = arm::rescale(length),
    bdload_l = log10(bd_load + 1),
    bdload_z = arm::rescale(bdload_l),
    shore_c = shore - mean(shore),
    male_c = male - mean(male),
    elevlo_c = elev_lo - mean(elev_lo),
    first_c = first - mean(first),
    across(c(shore_c, male_c, elevlo_c, first_c), round, 3), 
    across(c(site_id, shore_c, first_c, donor, male_c, elevlo_c, year), as.factor),
    surv = as.integer(surv))

# Add a descriptive translocation_id
d1 <- d1 %>% 
  distinct(site_id, year) %>% 
  arrange(site_id, year) %>% 
  group_by(site_id) %>% 
  mutate(transno = seq_len(n())) %>% 
  ungroup(site_id) %>% 
  unite(translocation_id, c("site_id", "transno"), remove = FALSE) %>% 
  select(-transno) %>% 
  mutate(translocation_id = as.factor(translocation_id)) %>% 
  inner_join(d1, by = c("site_id", "year")) %>% 
  relocate(translocation_id, .after = site_id)
```

### Model specification
```{r}
d1_72996 <- d1 %>% 
  filter(donor == "72996" & !is.na(bd_load))

m1d_72996 <- stan_glmer(
  surv ~ length_z + snowt_z + snowt1_z + day_z + bdload_z + elev_z + first_c + male_c + (1 | translocation_id),
  data = d1_72996,
  family = binomial,
  chains = 4, 
  iter = 5000*2, 
  cores = 4,
  seed = 84735)
```

### Priors & chain diagnostics
```{r}
prior_summary(m1d_72996)

b1_72996 <- c("(Intercept)", "length_z", "snowt_z", "snowt1_z", "day_z", "bdload_z", "elev_z", "first_c0.353", "male_c0.548")

mcmc_trace(m1d_72996, size = 0.1, pars = b1_72996)
mcmc_dens_overlay(m1d_72996, pars = b1_72996)

summary(m1d_72996)
```

### Posterior predictive check
```{r}
pp_check(m1d_72996, plotfun = "stat") +
    xlab("Frog survival rate")
```

### Posterior analysis
```{r}
tidy(m1d_72996, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1d_72996, area_method = "equal height", prob = 0.90, pars = b1_72996) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with standardized predictors & translocation_id as grouping variable",
          "Posterior distributions with medians & 90% uncertainty intervals")

mean(bayes_R2(m1d_72996))

# Frog survival by translocation_id
mcmc_areas_ridges(m1d_72996, regex_pars = "translocation_id") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Frog survival for each translocation_id")
```
- Using dataset containing only frogs translocated from 72996 had relatively little effect on the predictors of frog survival. Specific to the objective of this analysis, frog size remained unimportant as a predictor of survival. However, effect of Bd load became marginally unimportant instead of unimportant (i.e., uncertainty interval includes 0 but barely). 

## Assess effect on m1d of including all records, including where bd_load = NA

### Read in frog translocation dataset  
* Read in data, create variables for analysis, standardize continuous variables. 
* arm package used to rescale continuous variables (substract mean, divide by 2 SD), manual centering of binary variables.
```{r read-translocation-data-including-na}
d1_allna <- read_csv(here::here("data", "clean", "frog_translocation_final.csv")) %>% 
#  drop_na(bd_load) %>%  # drop 12 records where bd_load is NA (9 are from 70413)
  mutate(
    first = if_else(order == 1, 1, 0),
    surv = if_else(survival < 0.5, 0, 1),
    male = if_else(sex == "m", 1, 0),
    elev_lo = if_else(elevation < 3020, 1, 0), # using interval defined by cut_interval, n = 2
    elev_z = arm::rescale(elevation),
    snowt_z = arm::rescale(snow_t),
    snowt1_z = arm::rescale(snow_t1),
    day_z = arm::rescale(day),
    length_z = arm::rescale(length),
    bdload_l = log10(bd_load + 1),
    bdload_z = arm::rescale(bdload_l),
    shore_c = shore - mean(shore),
    male_c = male - mean(male),
    elevlo_c = elev_lo - mean(elev_lo),
    first_c = first - mean(first),
    across(c(shore_c, male_c, elevlo_c, first_c), round, 3), 
    across(c(site_id, shore_c, first_c, donor, male_c, elevlo_c, year), as.factor),
    surv = as.integer(surv))

# Add a descriptive translocation_id
d1_allna <- d1_allna %>% 
  distinct(site_id, year) %>% 
  arrange(site_id, year) %>% 
  group_by(site_id) %>% 
  mutate(transno = seq_len(n())) %>% 
  ungroup(site_id) %>% 
  unite(translocation_id, c("site_id", "transno"), remove = FALSE) %>% 
  select(-transno) %>% 
  mutate(translocation_id = as.factor(translocation_id)) %>% 
  inner_join(d1_allna, by = c("site_id", "year")) %>% 
  relocate(translocation_id, .after = site_id)
```

### Model specification
```{r}
m1d_allna <- stan_glmer(
  surv ~ length_z + snowt_z + snowt1_z + day_z + elev_z + first_c + male_c + donor + (1 | translocation_id),
  data = d1_allna,
  family = binomial,
  chains = 4, 
  iter = 5000*2, 
  cores = 4,
  seed = 84735)
```

### List model variable names
```{r}
get_variables(m1d_allna)
```

### Priors & chain diagnostics
```{r}
prior_summary(m1d_allna)

b1_allna <- c("(Intercept)", "length_z", "snowt_z", "snowt1_z", "day_z", "elev_z", "first_c0.349", "male_c0.549", "donor70567", "donor72996")

mcmc_trace(m1d_allna, size = 0.1, pars = b1_allna)
mcmc_dens_overlay(m1d_allna, pars = b1_allna)

summary(m1d_allna)
```

### Posterior predictive check
```{r}
pp_check(m1d_allna, plotfun = "stat") +
    xlab("Frog survival rate")
```

### Posterior analysis
```{r}
tidy(m1d_allna, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1d_allna, area_method = "equal height", prob = 0.90, pars = b1_allna) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with standardized predictors & translocation_id as grouping variable",
          "Posterior distributions with medians & 90% uncertainty intervals")

mean(bayes_R2(m1d_allna))

# Frog survival by translocation_id
mcmc_areas_ridges(m1d_allna, regex_pars = "translocation_id") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Frog survival for each translocation_id")
```

- Inclusion of all records (i.e., 12 records where bd_load = NA that were excluded in primary analysis) did not change the results.   




## Analysis of changes in Bd load following translocation
-  Compare loads at time of translocation to those from CMR years 0 and 1. Exclude years > 1. Only frogs that were recaptured at least once following translocation are included. 

### Create dataset 

### Load additional libraries
```{r}
library(RPostgreSQL)
library(lubridate)
```

### Read in raw translocation and capture datasets, bind them
```{r read-data}
translocation <- read_csv(here::here("data", "raw", "frog_translocation.csv")) %>% 
  relocate(visit_date = release_date, .before = type) %>% 
  rename(survey_type = type) %>% 
  mutate(pit_tag_ref = replace(pit_tag_ref, pit_tag_ref == "900067000117396" & site_id == 70641, "111111111111111")) %>% # remove incorrect pit_tag_ref identified in translocation_survival_createdata.Rmd
  filter(pit_tag_ref != "111111111111111")

capture <- read_csv(here::here("data", "raw", "frog_captures.csv")) %>% 
  select(-capture_life_stage, -capture_animal_state, -sex)

# select only translocated frogs (exclude naturally-recruited frogs and translocated frogs that were never recaptured after translocation)
capture <- translocation %>% 
  select(pit_tag_ref) %>% 
  inner_join(capture, by = c("pit_tag_ref")) %>% 
  relocate(pit_tag_ref, .after = last_col())

frogs_all <- bind_rows(translocation, capture)
```

### Connect to PostgreSQL database `amphibians`
```{r}
con = dbConnect(dbDriver("PostgreSQL"),
                user = rstudioapi::askForPassword("user name"),
                password = rstudioapi::askForPassword("password"),
                host = "frogdb.eri.ucsb.edu",
                port = 5432,
                dbname = "amphibians")

```

### Retrieve Bd data for translocated frogs from database
```{sql retrieve-translocation-bd-data, connection=con, output.var="translocate_bd"}
select
  release_date as visit_date,
  pit_tag_ref,
  swab_id,
  bd_load
from relocate
inner join relocate_frog on relocate.id = relocate_id
inner join bd_load on swab_id = sample_id  
where release_siteid1 in (70134, 70279, 70370, 70413, 70414, 70449, 70505, 70550, 70556, 70619, 70628, 70641, 74976) and
  (replicate = 1 or replicate is null)
```

### Retrieve Bd data for captured frogs from database
```{sql retrieve-capture-bd-data, connection=con, output.var="capture_bd"}
select
	visit_date,
	pit_tag_ref, 
	swab_id,
	bd_load
from visit
inner join survey on visit.id = visit_id
inner join capture_survey on survey.id = survey_id
inner join bd_load on swab_id = sample_id  
where site_id in (70134, 70688, 70370, 70114, 70175, 70279, 70413, 71570, 71968, 72008, 72093, 72264, 72390, 72442, 72694, 70414, 70449, 70034, 70505, 72092, 70550, 70556, 70619, 70628, 70641, 74976, 72973) and 
	survey_type = 'cmr' and
	capture_animal_state != 'dead' and
	(replicate = 1 or replicate is null)
```  

### Disconnect from database
```{r}
dbDisconnect(con) 
rm("con")
```

### Combine Bd data from translocate and capture datasets
```{r}
bd_add <- bind_rows(translocate_bd, capture_bd)
```

### Add Bd data to frog data, restructure dataset
```{r}
frogsbd <- frogs_all %>% 
  inner_join(bd_add, by = c("visit_date", "pit_tag_ref")) %>% 
  mutate(period = if_else(survey_type == "cmr", "after", "before")) %>% # use 0/1 instead?
  relocate(period, .after = survey_type) %>% 
  arrange(site_id, visit_date)
```

### Add years since translocation
```{r}
frogsbd <- translocation %>% 
  mutate(year_translocate = year(visit_date)) %>% 
  select(year_translocate, pit_tag_ref) %>% 
  inner_join(frogsbd, by = c("pit_tag_ref")) %>% 
  relocate(year_translocate, .after = visit_date) %>% 
  relocate(pit_tag_ref, .after = period) %>% 
  mutate(year_capture = year(visit_date), .after = year_translocate) %>% 
  mutate(interval = (year_capture - year_translocate), .after = year_capture) %>% 
  arrange(site_id, visit_date, pit_tag_ref)
```

### Update site ids to standardize usage
```{r}
frogsbd <- frogsbd %>% 
  mutate(site_id1 = site_id, .after = site_id,
         site_id1 = replace(site_id1, site_id == 70034, 70449),
         site_id1 = replace(site_id1, site_id == 70175, 70413),
         site_id1 = replace(site_id1, site_id == 70279, 70413),
         site_id1 = replace(site_id1, site_id == 72093, 70413),
         site_id1 = replace(site_id1, site_id == 72442, 70413),
         site_id1 = replace(site_id1, site_id == 70688, 70134),
         site_id1 = replace(site_id1, site_id == 72092, 70505),
         site_id1 = replace(site_id1, site_id == 72973, 74976))
```

### Add translocation_id
```{r}
frogsbd <- frogsbd %>% 
  distinct(site_id1, year_translocate) %>% 
  arrange(site_id1, year_translocate) %>% 
  group_by(site_id1) %>% 
  mutate(transno = seq_len(n())) %>% 
  ungroup(site_id1) %>% 
  unite(translocation_id, c("site_id1", "transno"), remove = FALSE) %>% 
  select(-transno) %>% 
  inner_join(frogsbd, by = c("site_id1", "year_translocate")) %>% 
  select(site_id, site_id1, translocation_id, visit_date, survey_type, period, year_translocate, year_capture, interval, pit_tag_ref, swab_id, bd_load) %>% 
  arrange(site_id1, visit_date)
```

### Save frog-Bd dataset
```{r}
frogsbd %>% write_csv(here::here("data", "clean", "bd_beforeafter_translocation.csv"))
```

## Analyze dataset
### Read in data, standardize variables
```{r}
d1 <- read_csv(here::here("data", "clean", "bd_beforeafter_translocation.csv")) %>% 
  mutate(after = if_else(period == "after", 1, 0),
         bd_load = as.integer(round(bd_load)),  # if using negative binomial distribution
         after_c = after - mean(after))
```

### Null values - check
```{r check-null}
d1 %>% summarize(across(everything(), ~ sum(is.na(.))))
```

### Include only CMR years 0 and 1
```{r}
d2 <- d1 %>% 
  filter(interval < 2)
```

### Plot distribution of bd_load response variable
```{r}
d2 %>% 
  ggplot(aes(x = bd_load)) +
    geom_histogram()

d2 %>% 
  ggplot(aes(sample = bd_load)) +
    geom_qq() +
    geom_qq_line()
```
* Data are strongly left-skewed, possibly zero-inflated. Model using negative binomial family.

### Model without group-level effects
#### Model specification
```{r}
m1a <- stan_glm(
  bd_load ~ after_c,
  data = d2,
  family = neg_binomial_2(),
  chains = 4, 
  iter = 5000*2,
  cores = 4,
  seed = 84735)
```

#### Priors and chain diagnostics
```{r}
prior_summary(m1a)

mcmc_trace(m1a, size = 0.1)
mcmc_dens_overlay(m1a)

summary(m1a)
```

#### Posterior predictive check
```{r}
pp_check(m1a, plotfun = "stat") +
    xlab("Bd load")
```

-   Posterior predictive distribution implied by regression model closely matches original data (based on mean Bd load).

#### Calculate loo
```{r}
loo_m1a <- loo(m1a, cores = 4, save_psis = TRUE)
print(loo_m1a)
```

#### Posterior analysis
```{r}
tidy(m1a, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1a, area_method = "equal height", prob = 0.90) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with standardized predictors, no group-level effects",
          "Posterior distributions with medians & 90% uncertainty intervals")

# mean(bayes_R2(m1a))   # bayes_R2 not available for negative binomials models in stanreg. 
```

### Model with 1 grouping variable: pit_tag_ref
#### Model specification
```{r}
m1b <- stan_glmer(
  bd_load ~ after_c + (1 | pit_tag_ref),
  data = d2,
  family = neg_binomial_2(),
  chains = 4, 
  iter = 5000*2,
  cores = 4,
  seed = 84735)
```

#### List model variable names

```{r}
get_variables(m1b)
```

#### Priors and chain diagnostics
```{r}
prior_summary(m1b)

b1 <- c("(Intercept)", "after_c")

mcmc_trace(m1b, size = 0.1, pars = b1)
mcmc_dens_overlay(m1b, pars = b1)

summary(m1b)
```

#### Posterior predictive check
```{r}
pp_check(m1b, plotfun = "stat") +
    xlab("Bd load")
```

-   Posterior predictive distribution implied by regression model shows some mismatch between actual data and model results (based on mean Bd load).

#### Calculate loo
```{r}
loo_m1b <- loo(m1b, cores = 4, save_psis = TRUE)
print(loo_m1b)
```

#### Posterior analysis
```{r}
tidy(m1b, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1b, area_method = "equal height", prob = 0.90, pars = b1) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with pit_tag_ref as grouping variable",
          "Posterior distributions with medians & 90% uncertainty intervals")

# mean(bayes_R2(m1b))
```

### Model with 2 grouping variables: pit_tag_ref nested within translocation_id
#### Model specification
```{r}
m1c <- stan_glmer(
  bd_load ~ after_c + (1 | pit_tag_ref) + (1 | translocation_id),
  data = d2,
  family = neg_binomial_2(),
  chains = 4, 
  iter = 5000*2,
  cores = 4,
  seed = 84735)
```

#### Priors and chain diagnostics
```{r}
prior_summary(m1c)

b1 <- c("(Intercept)", "after_c")

mcmc_trace(m1c, size = 0.1, pars = b1)
mcmc_dens_overlay(m1c, pars = b1)

summary(m1c)
```

#### Posterior predictive check
```{r}
pp_check(m1c, plotfun = "stat") +
    xlab("Bd load")
```

-   Posterior predictive distribution implied by regression model closely matches original data (based on mean Bd load).

#### Calculate loo
```{r}
loo_m1c <- loo(m1c, cores = 4, save_psis = TRUE)
print(loo_m1c)
```

#### Posterior analysis
```{r}
tidy(m1c, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1c, area_method = "equal height", prob = 0.90, pars = b1) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with pit_tag_ref and translocation_id as grouping variables",
          "Posterior distributions with medians & 90% uncertainty intervals")

# mean(bayes_R2(m1c))
```

### Model with 2 grouping variables: pit_tag_ref nested within site_id1
#### Model specification
```{r}
m1d <- stan_glmer(
  bd_load ~ after_c + (1 | pit_tag_ref) + (1 | site_id1),
  data = d2,
  family = neg_binomial_2(),
  chains = 4, 
  iter = 5000*2,
  cores = 4,
  seed = 84735)
```

#### Priors and chain diagnostics
```{r}
prior_summary(m1d)

b1 <- c("(Intercept)", "after_c")

mcmc_trace(m1d, size = 0.1, pars = b1)
mcmc_dens_overlay(m1d, pars = b1)

summary(m1d)
```

#### Posterior predictive check
```{r}
pp_check(m1d, plotfun = "stat") +
    xlab("Bd load")
```

-   Posterior predictive distribution implied by regression model closely matches original data (based on mean Bd load).

#### Calculate loo
```{r}
loo_m1d <- loo(m1d, cores = 4, save_psis = TRUE)
print(loo_m1d)
```

#### Posterior analysis
```{r}
tidy(m1d, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1d, area_method = "equal height", prob = 0.90, pars = b1) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with pit_tag_ref and site_id1 as grouping variables",
          "Posterior distributions with medians & 90% uncertainty intervals")

# mean(bayes_R2(m1d))
```

## Compare 4 models with different grouping structures
```{r}
loo_compare(loo_m1a, loo_m1b, loo_m1c, loo_m1d)
```
