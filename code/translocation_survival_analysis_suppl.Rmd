---
title: "Predictors of frog survival following translocations - supplemental analyses"
author: "Roland Knapp"
output: html_notebook
---

The supplemental analyses in this notebook provide additional details to analyses in `translocation_survival_analysis.Rmd`. 

## Load packages

```{r load-packages}
library(tidyverse)
library(brms)
library(rstanarm)
library(bayesplot)
library(tidybayes)
library(loo)
library(broom.mixed)
library(janitor)

source("classification_summary.R")
```


## Evaluate effect of frog size independent of donor population: Model m1d from `translocation_survival_analysis.Rmd` but using data subset where donor = 72996

### Read in frog translocation dataset  
* Read in data, create variables for analysis, standardize continuous variables. 
* arm package used to rescale continuous variables (substract mean, divide by 2 SD), manual centering of binary variables.
```{r read-translocation-data}
d1 <- read_csv(here::here("data", "clean", "frog_translocation_final.csv")) %>% 
  drop_na(bd_load) %>%  # drop 12 records where bd_load is NA (9 are from 70413)
  mutate(
    first = if_else(order == 1, 1, 0),
    surv = if_else(survival < 0.5, 0, 1),
    male = if_else(sex == "m", 1, 0),
    elev_lo = if_else(elevation < 3020, 1, 0), # using interval defined by cut_interval, n = 2
    elev_z = arm::rescale(elevation),
    snowt_z = arm::rescale(snow_t),
    snowt1_z = arm::rescale(snow_t1),
    day_z = arm::rescale(day),
    length_z = arm::rescale(length),
    bdload_l = log10(bd_load + 1),
    bdload_z = arm::rescale(bdload_l),
    shore_c = shore - mean(shore),
    male_c = male - mean(male),
    elevlo_c = elev_lo - mean(elev_lo),
    first_c = first - mean(first),
    across(c(shore_c, male_c, elevlo_c, first_c), round, 3), 
    across(c(site_id, shore_c, first_c, donor, male_c, elevlo_c, year), as.factor),
    surv = as.integer(surv))

# Add a descriptive translocation_id
d1 <- d1 %>% 
  distinct(site_id, year) %>% 
  arrange(site_id, year) %>% 
  group_by(site_id) %>% 
  mutate(transno = seq_len(n())) %>% 
  ungroup(site_id) %>% 
  unite(translocation_id, c("site_id", "transno"), remove = FALSE) %>% 
  select(-transno) %>% 
  mutate(translocation_id = as.factor(translocation_id)) %>% 
  inner_join(d1, by = c("site_id", "year")) %>% 
  relocate(translocation_id, .after = site_id)
```

### Model specification
```{r}
d1_72996 <- d1 %>% 
  filter(donor == "72996" & !is.na(bd_load))

m1d_72996 <- stan_glmer(
  surv ~ length_z + snowt_z + snowt1_z + day_z + bdload_z + elev_z + first_c + male_c + (1 | translocation_id),
  data = d1_72996,
  family = binomial,
  chains = 4, 
  iter = 5000*2, 
  cores = 4,
  seed = 84735)
```

### Priors & chain diagnostics
```{r}
prior_summary(m1d_72996)

b1_72996 <- c("(Intercept)", "length_z", "snowt_z", "snowt1_z", "day_z", "bdload_z", "elev_z", "first_c0.353", "male_c0.548")

mcmc_trace(m1d_72996, size = 0.1, pars = b1_72996)
mcmc_dens_overlay(m1d_72996, pars = b1_72996)

summary(m1d_72996)
```

### Posterior predictive check
```{r}
pp_check(m1d_72996, plotfun = "stat") +
    xlab("Frog survival rate")
```

### Posterior analysis
```{r}
tidy(m1d_72996, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1d_72996, area_method = "equal height", prob = 0.90, pars = b1_72996) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with standardized predictors & translocation_id as grouping variable",
          "Posterior distributions with medians & 90% uncertainty intervals")

mean(bayes_R2(m1d_72996))

# Frog survival by translocation_id
mcmc_areas_ridges(m1d_72996, regex_pars = "translocation_id") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Frog survival for each translocation_id")
```
- Using dataset containing only frogs translocated from 72996 had relatively little effect on the predictors of frog survival. Specific to the objective of this analysis, frog size remained unimportant as a predictor of survival. However, effect of Bd load became marginally unimportant instead of unimportant (i.e., uncertainty interval includes 0 but barely). 

## Assess effect on m1d of including all records, including where bd_load = NA

### Read in frog translocation dataset  
* Read in data, create variables for analysis, standardize continuous variables. 
* arm package used to rescale continuous variables (substract mean, divide by 2 SD), manual centering of binary variables.
```{r read-translocation-data-including-na}
d1_allna <- read_csv(here::here("data", "clean", "frog_translocation_final.csv")) %>% 
#  drop_na(bd_load) %>%  # drop 12 records where bd_load is NA (9 are from 70413)
  mutate(
    first = if_else(order == 1, 1, 0),
    surv = if_else(survival < 0.5, 0, 1),
    male = if_else(sex == "m", 1, 0),
    elev_lo = if_else(elevation < 3020, 1, 0), # using interval defined by cut_interval, n = 2
    elev_z = arm::rescale(elevation),
    snowt_z = arm::rescale(snow_t),
    snowt1_z = arm::rescale(snow_t1),
    day_z = arm::rescale(day),
    length_z = arm::rescale(length),
    bdload_l = log10(bd_load + 1),
    bdload_z = arm::rescale(bdload_l),
    shore_c = shore - mean(shore),
    male_c = male - mean(male),
    elevlo_c = elev_lo - mean(elev_lo),
    first_c = first - mean(first),
    across(c(shore_c, male_c, elevlo_c, first_c), round, 3), 
    across(c(site_id, shore_c, first_c, donor, male_c, elevlo_c, year), as.factor),
    surv = as.integer(surv))

# Add a descriptive translocation_id
d1_allna <- d1_allna %>% 
  distinct(site_id, year) %>% 
  arrange(site_id, year) %>% 
  group_by(site_id) %>% 
  mutate(transno = seq_len(n())) %>% 
  ungroup(site_id) %>% 
  unite(translocation_id, c("site_id", "transno"), remove = FALSE) %>% 
  select(-transno) %>% 
  mutate(translocation_id = as.factor(translocation_id)) %>% 
  inner_join(d1_allna, by = c("site_id", "year")) %>% 
  relocate(translocation_id, .after = site_id)
```

### Model specification
```{r}
m1d_allna <- stan_glmer(
  surv ~ length_z + snowt_z + snowt1_z + day_z + elev_z + first_c + male_c + donor + (1 | translocation_id),
  data = d1_allna,
  family = binomial,
  chains = 4, 
  iter = 5000*2, 
  cores = 4,
  seed = 84735)
```

### List model variable names
```{r}
get_variables(m1d_allna)
```

### Priors & chain diagnostics
```{r}
prior_summary(m1d_allna)

b1_allna <- c("(Intercept)", "length_z", "snowt_z", "snowt1_z", "day_z", "elev_z", "first_c0.349", "male_c0.549", "donor70567", "donor72996")

mcmc_trace(m1d_allna, size = 0.1, pars = b1_allna)
mcmc_dens_overlay(m1d_allna, pars = b1_allna)

summary(m1d_allna)
```

### Posterior predictive check
```{r}
pp_check(m1d_allna, plotfun = "stat") +
    xlab("Frog survival rate")
```

### Posterior analysis
```{r}
tidy(m1d_allna, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1d_allna, area_method = "equal height", prob = 0.90, pars = b1_allna) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with standardized predictors & translocation_id as grouping variable",
          "Posterior distributions with medians & 90% uncertainty intervals")

mean(bayes_R2(m1d_allna))

# Frog survival by translocation_id
mcmc_areas_ridges(m1d_allna, regex_pars = "translocation_id") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Frog survival for each translocation_id")
```

- Inclusion of all records (i.e., 12 records where bd_load = NA that were excluded in primary analysis) did not change the results.   


