---
title: "Predictors of frog survival following translocations - create dataset"
author: "Roland Knapp"
output: html_notebook
---

The code in this notebook creates a dataset for use in an analysis to identify predictors of frog survival following translocation (translocation_survival_analysis.Rmd). The code is written in distinct chunks to allow review of the output from one chunk before running the next. Users without credentials to access the database will not be able to create the raw data files, but can use the saved files to run the remainder of the code. Frog translocation and survival data were generated using code in the [SNARL1/cmr-analysis](https://github.com/SNARL1/cmr-analysis) GitHub repository.

### Load packages

```{r load_packages}
library(RPostgreSQL)
library(tidyverse) 
library(lubridate)
```

## Create site characteristics dataset

### Connect to database

```{r db_connect1}
con = dbConnect(dbDriver("PostgreSQL"),
                host = Sys.getenv("host"), 
                port = Sys.getenv("port"), 
                dbname = Sys.getenv("dbname"),
                user = rstudioapi::askForPassword("user name"),
                password = rstudioapi::askForPassword("password")
               )
```

### Retrieve site_ids and site characteristics from database

```{sql retrieve_site_data, connection=con, output.var="translocation_sites"}
select
  id as site_id,
  elevation
from site
where id in (70134, 70370, 70413, 70414, 70449, 70505, 70550, 70556, 70619, 70628, 70641, 74976)
order by site_id
```

### Disconnect from database

```{r db_disconnect1}
dbDisconnect(con)
rm(con)
```

### Add additional site characteristics

```{r sites_add_shore}
translocation_sites <- translocation_sites %>% 
  mutate(shore = if_else(site_id %in% c(70370, 70413, 70550, 70556, 70619, 70628, 74976), 1, 0),
         site_id = as.character(site_id))
```

### Save site characteristics dataset

```{r save_site_data}
translocation_sites %>% write_csv(here::here("data", "clean", "translocation_sites.csv"))
# translocation_sites <- read_csv(here::here("data", "translocation_sites.csv"))
```

## Create translocated frogs dataset

### Combine translocation files from cmr-analysis repo

```{r retrieve_translocated_frogs_data }
files <- fs::dir_ls("../../cmr-analysis/data/clean", glob = "*translocation.csv")
frog_translocation <- read_csv(files, id = "path") %>% 
  mutate(site_id = str_extract(path, "(\\d)+"), .after = path) %>%  
  filter(release_date < "2021-01-01") %>% 
  rename(pit_tag_ref = pit_tag_id) %>% 
  select(-path)
rm(files)
```

### Save raw translocated frog dataset

```{r save_raw_translocated_frogs_datra}
frog_translocation %>% write_csv(here::here("data", "raw", "frog_translocation_raw.csv"))
```

### Add frog characteristics from database

#### Connect to database

```{r db_connect2}
con = dbConnect(dbDriver("PostgreSQL"),
                host = Sys.getenv("host"), 
                port = Sys.getenv("port"), 
                dbname = Sys.getenv("dbname"),
                user = rstudioapi::askForPassword("user name"),
                password = rstudioapi::askForPassword("password")
               )
```

#### Retrieve frog characteristics from database

```{sql retrieve_translocation_data, connection=con, output.var="frog_characteristics"}
select
  relocate.id as relocate_id,
  release_siteid1,
  release_date,
  collect_siteid,
  type,
  pit_tag_ref,
  sex,
  length,
  weight,
  swab_id,
  bd_load
from relocate
inner join relocate_frog on relocate.id = relocate_id
left join bd_load on swab_id = sample_id  
where release_siteid1 in (70134, 70279, 70370, 70413, 70414, 70449, 70505, 70550, 70556, 70619, 70628, 70641, 74976) and
  (replicate = 1 or replicate is null)
order by release_siteid1
```

#### Disconnect from database

```{r db_disconnect2}
dbDisconnect(con)
rm(con)
```

### Save raw frog characteristics dataset

```{r save_frog_characteristics_data}
frog_characteristics %>% write_csv(here::here("data", "raw", "frog_characteristics_raw.csv"))
# translocation_sites <- read_csv(here::here("data", "translocation_sites.csv"))
```

## Create frog survival dataset

### Combine survival files from cmr-analysis repo

```{r retrieve_frog_survival_data}
files <- fs::dir_ls("../../cmr-analysis/out/tables", glob = "*ind.csv")
frog_survival <- read_csv(files, id = "path") %>% 
  mutate(site_id = str_extract(path, "(\\d)+"), .after = path) %>%  
  rename(years_since_intro = years_since_introduction,
         pit_tag_ref = pit_tag_id) %>% 
  filter(years_since_intro == 1) %>% 
  select(site_id, release_date, years_since_intro, pit_tag_ref, median_survival)
rm(files)
```

### Save raw frog survival dataset

```{r save_raw_frog_survival_data}
frog_survival %>% write_csv(here::here("data", "raw", "frog_survival_raw.csv"))
```

### Data checks - first pass

```{r data_checking}
# Check for duplicate pit_tag_refs
frog_translocation %>% count(pit_tag_ref) %>% filter(n > 1)
frog_characteristics %>% count(pit_tag_ref) %>% filter(n > 1)
frog_survival %>% count(pit_tag_ref) %>% filter(n > 1)
```

### Clean data - first pass

```{r data_cleaning_step1}
# Duplicate pit_tag_ref found in frog_translocation, frog_characteristics, and frog survival datasets.
# Shown as released at 70641 and 74976, but subsequently only recaptured at 74976 so that record is incorrect.
# Recode as pit_tag_ref not found in database
frog_translocation <- frog_translocation %>% mutate(
  pit_tag_ref = replace(pit_tag_ref, site_id == "70641" & pit_tag_ref == "900067000117396", "900067000117397"))
frog_characteristics <- frog_characteristics %>% mutate(
  pit_tag_ref = replace(pit_tag_ref, release_siteid1 == 70641 & pit_tag_ref == "900067000117396", "900067000117397"))
frog_survival <-frog_survival %>% mutate(
  pit_tag_ref = replace(pit_tag_ref, site_id == "70641" & pit_tag_ref == "900067000117396", "900067000117397"))
```

### Add frog and site characteristics to frog translocation dataset
```{r join_frog_data}
frog_characteristics <- frog_characteristics %>% 
  mutate(release_siteid1 = as.character(release_siteid1)) %>% 
  select(-relocate_id, -release_siteid1, -release_date, -type)
  as_tibble()
  
frog_survival <- frog_survival %>% 
  select(pit_tag_ref, median_survival)
  
frog_translocation <- frog_translocation %>% 
  left_join(frog_characteristics, by = "pit_tag_ref") %>% 
  left_join(frog_survival, by = "pit_tag_ref") %>% 
  left_join(translocation_sites, by = "site_id")
```

### Check data - second pass
```{r}
# Check for null values
frog_translocation %>% summarize(across(everything(), ~ sum(is.na(.))))

# Check that site_ids match expectation
frog_translocation %>% distinct(site_id, collect_siteid)
```

### Clean data - second pass

```{r}
# Missing frog characteristics associated with pit_tag_ref = 900067000114499. 
# Replace null values (except bd_load) with values from capture at release site early the next summer. 
# Bd_load not replaced because load could have changed between release and recapture. 

# Missing frog characteristics associated with pit_tag_ref = 900118001027669 
# Replace null values with values from capture at release site 1-2 weeks later. 
# Bd_load replaced because load likely would not have changed much between release and recapture. 

frog_translocation <- frog_translocation %>% 
  mutate(
    collect_siteid = replace(collect_siteid, is.na(collect_siteid) & site_id == "70641" & pit_tag_ref == "900067000114499", "72996"),
    sex = replace(sex, is.na(sex) & site_id == "70641" & pit_tag_ref == "900067000114499", "f"),
    length = replace(length, is.na(length) & site_id == "70641" & pit_tag_ref == "900067000114499", 52),
    weight = replace(weight, is.na(weight) & site_id == "70641" & pit_tag_ref == "900067000114499", 12),
    length = replace(length, is.na(length) & site_id == "70413" & pit_tag_ref == "900118001027669", 52),
    weight = replace(weight, is.na(weight) & site_id == "70413" & pit_tag_ref == "900118001027669", 16),
    swab_id = replace(swab_id, swab_id == "" & site_id == "70413" & pit_tag_ref == "900118001027669", "YFS364"),
    bd_load = replace(bd_load, is.na(bd_load) & site_id == "70413" & pit_tag_ref == "900118001027669", 0))

# Collect_siteid 72974 merged with adjacent larger 70459
frog_translocation <- frog_translocation %>% 
  mutate(collect_siteid = replace(collect_siteid, collect_siteid == "72974" & site_id == "70556", "70459"))
```


### Check data - third pass
```{r}
#### Connect to database
con = dbConnect(dbDriver("PostgreSQL"),
                host = Sys.getenv("host"), 
                port = Sys.getenv("port"), 
                dbname = Sys.getenv("dbname"),
                user = rstudioapi::askForPassword("user name"),
                password = rstudioapi::askForPassword("password")
               )
```
```{sql retrieve_capture_data, connection=con, output.var="frog_captures"}
select
	site_id,
	visit_date,
	survey_type,
	capture_life_stage,
	capture_animal_state,
	pit_tag_ref, 
	sex 
from visit
inner join survey on visit.id = visit_id
inner join capture_survey on survey.id = survey_id
inner join surveyor on surveyor.id = surveyor_id
where site_id in (70134, 70688, 70370, 70114, 70175, 70279, 70413, 71570, 71968, 72008, 72093, 72264, 72390, 72442, 72694, 70414, 70449, 70034, 70505, 72092, 70550, 70556, 70619, 70628, 70641, 74976, 72973) and 
	survey_type = 'cmr' and
	capture_animal_state != 'dead' 
```
```{r}
dbDisconnect(con)
rm(con)
```
```{r}
# Check if sex at collection matches sex on recapture
frog_captures %>% distinct(pit_tag_ref, sex) %>% count(pit_tag_ref, sex) %>% filter(n > 1)
frog_captures %>% distinct(pit_tag_ref, sex) %>% 
  rename(sexcapture = sex) %>% 
  inner_join(frog_translocation, by = "pit_tag_ref") %>% 
  filter(sex != sexcapture)
```
```{r}
# Plot length x weight to check for outliers
frog_translocation %>% ggplot(aes(x = length, y = weight)) +
  geom_point() +
  geom_smooth(method = lm)

frog_translocation %>% ggplot(aes(x = log10(length), y = log10(weight))) +
  geom_point() +
  geom_smooth(method = gam)

```
No obvious outliers. 

### Clean data - third pass

```{r}
# Change sex at time of translocation based on subsequent recaptures
frog_translocation <- frog_translocation %>% 
  mutate(sex = replace(sex, pit_tag_ref == "900067000117464" & sex == "f", "m"),
         sex = replace(sex, pit_tag_ref == "982000365440205" & sex == "f", "m"),
         sex = replace(sex, pit_tag_ref == "900067000114152" & sex == "m", "f"))
```

### Add translocation order

```{r}
frog_translocation %>% 
  distinct(site_id, release_date) %>% 
  group_by(site_id) %>% 
  mutate(order = seq_len(n())) %>% 
  arrange(site_id, release_date) %>% 
  inner_join(frog_translocation, by = c("site_id", "release_date")) 
  ungroup() -> frog_translocation
```

### Extract day-of-year and year from date

```{r}
frog_translocation <- frog_translocation %>% 
  mutate(day = yday(release_date),
         year = year(release_date))
```

### Check for null values

```{r}
# Check for null values
frog_translocation %>% summarize(across(everything(), ~ sum(is.na(.))))
```

### Create final dataset

```{r}
frog_translocation <- frog_translocation %>% 
  rename(survival = median_survival,
         donor = collect_siteid,
         date = release_date) %>% 
  select(site_id, elevation, shore, date, day, year, order, pit_tag_ref, donor, sex, length, weight, bd_load, survival) 
```



### Save clean frog translocation dataset

```{r save_clean_frog_translocation_data}
frog_translocation %>% 
   write_csv(here::here("data", "clean", "frog_translocation.csv"))
```




