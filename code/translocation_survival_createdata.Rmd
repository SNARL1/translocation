---
title: "Predictors of frog survival following translocations - create dataset"
author: "Roland Knapp"
date: "`r Sys.Date()`"
output: html_notebook
---

The code in this notebook creates a dataset for use in analyses to identify predictors of frog survival following translocation (using translocation_survival_analysis.Rmd).
The code is written in distinct chunks to allow review of the output from one chunk before running the next.
Users without credentials to access the database will not be able to create several of the raw data files, but can use the saved raw data files to run the remainder of the code.
Frog translocation and survival data were generated using code in the [SNARL1/cmr-analysis](https://github.com/SNARL1/cmr-analysis) GitHub repository.

## Load packages

```{r load-packages}
library(RPostgreSQL)
library(tidyverse) 
library(lubridate)
```

## Create raw sites, frog characteristics, and frog captures data files

### Connect to database
```{r db-connect}
source("db_connect.R")
```

### Create site characteristics dataset

#### Retrieve site-level data from database

```{sql retrieve-site-data, connection=con, output.var="translocation_sites"}
select
  id as site_id,
  elevation
from site
where id in (70134, 70370, 70413, 70414, 70449, 70505, 70550, 70556, 70619, 70628, 70641, 74976)
order by site_id
```

#### Add additional site characteristics

```{r sites-add-shore}
translocation_sites <- translocation_sites %>% 
  mutate(shore = if_else(site_id %in% c(70370, 70413, 70550, 70556, 70619, 70628, 74976), 1, 0),
         site_id = as.character(site_id))
```

#### Save site characteristics dataset

```{r save-site-data}
translocation_sites %>% write_csv(here::here("data", "raw", "translocation_sites.csv"))
# translocation_sites <- read_csv(here::here("data", "raw", "translocation_sites.csv"))
```

### Create frog characteristics dataset

#### Retrieve frog characteristics from database

```{sql retrieve-translocation-data, connection=con, output.var="frog_characteristics"}
select
  relocate.id as relocate_id,
  release_siteid1,
  release_date,
  collect_siteid,
  type,
  pit_tag_ref,
  sex,
  length,
  weight,
  swab_id,
  bd_load
from relocate
inner join relocate_frog on relocate.id = relocate_id
left join bd_load on swab_id = sample_id  
where release_siteid1 in (70134, 70279, 70370, 70413, 70414, 70449, 70505, 70550, 70556, 70619, 70628, 70641, 74976) and
  (replicate = 1 or replicate is null)
order by release_siteid1
```

#### Save raw frog characteristics dataset

```{r save-frog-characteristics-data}
frog_characteristics %>% write_csv(here::here("data", "raw", "frog_characteristics.csv"))
# frog_characteristics <- read_csv(here::here("data", "raw", "frog_characteristics.csv"))
```

### Create frog captures dataset for error checking step ("check-sex")

#### Retrieve frog captures from database

```{sql retrieve_capture_data, connection=con, output.var="frog_captures"}
select
	site_id,
	visit_date,
	survey_type,
	capture_life_stage,
	capture_animal_state,
	pit_tag_ref, 
	sex 
from visit
inner join survey on visit.id = visit_id
inner join capture_survey on survey.id = survey_id
inner join surveyor on surveyor.id = surveyor_id
where site_id in (70134, 70688, 70370, 70114, 70175, 70279, 70413, 71570, 71968, 72008, 72093, 72264, 72390, 72442, 72694, 70414, 70449, 70034, 70505, 72092, 70550, 70556, 70619, 70628, 70641, 74976, 72973) and 
	survey_type = 'cmr' and
	capture_animal_state != 'dead' 
```

#### Save frog captures dataset

```{r save-frog-captures-data}
frog_captures %>% write_csv(here::here("data", "raw", "frog_captures.csv"))
# frog_captures <- read_csv(here::here("data", "raw", "frog_captures.csv"))
```


### Disconnect from database

```{r db-disconnect}
source("db_disconnect.R")
```

## Create translocated frogs dataset

### Combine translocation files

The files accessed by this code chunk are generated by code in the xxxxx_createdata_mrmr.Rmd files in the [cmr-analysis](https://github.com/SNARL1/cmr-analysis) GitHub repo (version 2021), and copies are added to the /data/raw/cmr-analysis/translocation/ directory in this (i.e., translocation) repo.

```{r retrieve-translocated-frogs-data }
files <- fs::dir_ls(here::here("data", "raw", "cmr-analysis", "translocation"))  
frog_translocation <- read_csv(files, id = "path") %>% 
  mutate(site_id = str_extract(path, "(\\d)+"), .after = path) %>%  # extracts site_id as numeric string from file path
  filter(release_date < "2021-01-01") %>%  # only include frogs translocated before 2021
  rename(pit_tag_ref = pit_tag_id) %>% 
  select(-path)
rm(files)
```

### Save raw translocated frog dataset

```{r save-raw-translocated-frogs-data}
frog_translocation %>% write_csv(here::here("data", "raw", "frog_translocation.csv"))
# frog_translocation <- read_csv(here::here("data", "raw", "frog_translocation.csv"))
```

## Create frog survival dataset

### Combine frog survival files

The files accessed by this code chunk are generated by code in the xxxxx_analysis_mrmr.Rmd files in the [cmr-analysis](https://github.com/SNARL1/cmr-analysis) GitHub repo (version 2021), and copies are added to the /data/raw/cmr-analysis/survival/ directory in this (i.e., translocation) repo.

```{r retrieve-frog-survival-data}
files <- fs::dir_ls(here::here("data", "raw", "cmr-analysis", "survival"), glob = "*_ind.csv")
frog_survival <- read_csv(files, id = "path") %>% 
  mutate(site_id = str_extract(path, "(\\d)+"), .after = path) %>%  # extracts site_id as numeric string from file path
  rename(years_since_intro = years_since_introduction,
         pit_tag_ref = pit_tag_id) %>% 
  filter(years_since_intro == 1) %>% 
  select(site_id, release_date, years_since_intro, pit_tag_ref, median_survival)
rm(files)
```

### Save raw frog survival dataset

```{r save-raw-frog-survival-data}
frog_survival %>% write_csv(here::here("data", "raw", "frog_survival.csv"))
# frog_survival <- read_csv(here::here("data", "raw", "frog_survival.csv"))
```

### Data checks #1

Check for duplicate pit_tag_refs that could affect table joins.

```{r data-check1}
frog_translocation %>% count(pit_tag_ref) %>% filter(n > 1)
frog_characteristics %>% count(pit_tag_ref) %>% filter(n > 1)
frog_survival %>% count(pit_tag_ref) %>% filter(n > 1)
```

### Clean data #1

The same duplicate pit_tag_ref was found in frog_translocation, frog_characteristics, and frog survival datasets.
That tag was recorded from frogs released at 70641 and 74976, but tag was subsequently only recaptured at 74976: tag associated with 70641 is incorrect.
Recode erroneous tag as a pit_tag_ref not present in database to avoid errors during table joins.

```{r data-clean1}
frog_translocation <- frog_translocation %>% 
  mutate(pit_tag_ref = replace(pit_tag_ref, site_id == "70641" & pit_tag_ref == "900067000117396", "900067000117397"))
frog_characteristics <- frog_characteristics %>% 
  mutate(pit_tag_ref = replace(pit_tag_ref, release_siteid1 == 70641 & pit_tag_ref == "900067000117396", "900067000117397"))
frog_survival <-frog_survival %>% 
  mutate(pit_tag_ref = replace(pit_tag_ref, site_id == "70641" & pit_tag_ref == "900067000117396", "900067000117397"))
```

### Add frog, translocation, and site characteristics to frog translocation dataset

```{r join-frog-data}
frog_characteristics <- frog_characteristics %>% 
  mutate(release_siteid1 = as.character(release_siteid1)) %>% 
  select(-relocate_id, -release_siteid1, -release_date, -type)

frog_survival <- frog_survival %>% 
  select(pit_tag_ref, median_survival)
  
frog_translocation <- frog_translocation %>% 
  left_join(frog_characteristics, by = "pit_tag_ref") %>% 
  left_join(frog_survival, by = "pit_tag_ref") %>% 
  left_join(translocation_sites, by = "site_id")

# Add translocation order
frog_translocation <- frog_translocation %>%  
  distinct(site_id, release_date) %>% 
  group_by(site_id) %>% 
  mutate(order = seq_len(n())) %>% 
  ungroup() %>% 
  inner_join(frog_translocation, by = c("site_id", "release_date"))
```

### Check data #2

Check for null values and that donor-recipient site_ids match expectation

```{r data-check2}
frog_translocation %>% summarize(across(everything(), ~ sum(is.na(.))))

frog_translocation %>% distinct(site_id, collect_siteid)
```

### Clean data #2

Missing frog characteristics associated with pit_tag_ref = 900067000114499.
Replace null values (except bd_load) with values from capture at release site early the next summer.
Bd_load not replaced because load could have changed during the \>9 months between release and recapture.

Missing frog characteristics associated with pit_tag_ref = 900118001027669.
Replace null values with values from capture at release site 1-2 weeks later.
Bd_load replaced because load likely would not have changed much in the short time period between release and recapture.

Collection (= donor) site_id 72974 recorded as a distinct site despite being closely associated with 70459.
Therefore, merged 72974 into the larger site.

```{r data-clean2}
frog_translocation <- frog_translocation %>% 
  mutate(
    collect_siteid = replace(collect_siteid, is.na(collect_siteid) & site_id == "70641" & pit_tag_ref == "900067000114499", "72996"),
    sex = replace(sex, is.na(sex) & site_id == "70641" & pit_tag_ref == "900067000114499", "f"),
    length = replace(length, is.na(length) & site_id == "70641" & pit_tag_ref == "900067000114499", 52),
    weight = replace(weight, is.na(weight) & site_id == "70641" & pit_tag_ref == "900067000114499", 12),
    length = replace(length, is.na(length) & site_id == "70413" & pit_tag_ref == "900118001027669", 52),
    weight = replace(weight, is.na(weight) & site_id == "70413" & pit_tag_ref == "900118001027669", 16),
    swab_id = replace(swab_id, swab_id == "" & site_id == "70413" & pit_tag_ref == "900118001027669", "YFS364"),
    bd_load = replace(bd_load, is.na(bd_load) & site_id == "70413" & pit_tag_ref == "900118001027669", 0))

frog_translocation <- frog_translocation %>% 
  mutate(collect_siteid = replace(collect_siteid, collect_siteid == "72974" & site_id == "70556", "70459"))
```

### Check data #3

#### Check if sex is correct.

Sex was recorded for frogs immediately prior to their translocation and should match the sex recorded on recapture at the recipient site.
Mismatches are often due to frog sex being mis-identified at the donor site due to typically small sizes of frogs at some of the donor sites.

The result from the first line of this code chunk indicates that there were likely no errors in sex recorded at recipient site when frogs were recaptured. 
Therefore, it is a useful check to compare sex recorded at translocation to sex recorded at recipient site (next 4 lines). 
Three mismatches were detected. 

```{r check-sex}
frog_captures %>% distinct(pit_tag_ref, sex) %>% count(pit_tag_ref, sex) %>% filter(n > 1) # make sure that only one sex recorded per tag at recipient site

frog_captures %>% distinct(pit_tag_ref, sex) %>% 
  rename(sexcapture = sex) %>% 
  inner_join(frog_translocation, by = "pit_tag_ref") %>% 
  filter(sex != sexcapture)
```

#### Check for possible errors in frog length and weight

Plot frog length x weight to check for outliers - no extreme residuals observed

```{r check-length-weight}
frog_translocation %>% ggplot(aes(x = length, y = weight)) +
  geom_point() +
  geom_smooth(method = "lm")

frog_translocation %>% ggplot(aes(x = log10(length), y = log10(weight))) +
  geom_point() +
  geom_smooth(method = "lm")
```

### Clean data #3

Change sex recorded at donor site at time of translocation, based on subsequent recaptures at recipient site.

```{r update-sex}
frog_translocation <- frog_translocation %>% 
  mutate(sex = replace(sex, pit_tag_ref == "900067000117464" & sex == "f", "m"),
         sex = replace(sex, pit_tag_ref == "982000365440205" & sex == "f", "m"),
         sex = replace(sex, pit_tag_ref == "900067000114152" & sex == "m", "f"))
```

### Create day-of-year and year columns from date

```{r add-day-year}
frog_translocation <- frog_translocation %>% 
  mutate(day = yday(release_date),
         year = year(release_date))
```

### Add snowpack data for winter of and winter following translocation

```{r add-snowpack}

source("snowwc_clean.R")

frog_translocation <- snowwc_dan %>% 
  mutate(year_t = year, 
         year_t1 = (year + 1)) %>% 
  rename(snow_t = snowwc_cm) %>% 
  select(year, year_t, year_t1, snow_t) %>% 
  inner_join(snowwc_dan, by = c("year_t1" = "year")) %>% 
  rename(snow_t1 = snowwc_cm) %>% 
  select(-station_id, -date, -snowwc_pave) %>% 
  inner_join(frog_translocation, by = "year")
```

### Final data check

#### Check for null values

Results as expected. 

```{r check-null}
frog_translocation %>% summarize(across(everything(), ~ sum(is.na(.))))
```

### Create final dataset

```{r final-translocation-dataset}
frog_translocation <- frog_translocation %>% 
  rename(survival = median_survival,
         donor = collect_siteid,
         date = release_date) %>% 
  select(site_id, elevation, shore, snow_t, snow_t1, date, year, day, order, pit_tag_ref, donor, sex, length, weight, bd_load, survival) 
```

### Save clean frog translocation dataset

```{r save_clean_translocation_data}
frog_translocation %>% write_csv(here::here("data", "clean", "frog_translocation_final.csv"))
# frog_translocation <- read_csv(here::here("data", "clean", "frog_translocation_final.csv"))
```

### Description of dataset columns
- site_id: Unique 5-digit site identifier.
- elevation: Elevation of site above sea level (in meters). Obtained from 7.5' USGS topographic maps. 
- shore: Complex shoreline habitats (boulders, overhanging banks, rock crevices) available to frogs during winter, or not present and/or unavailable due to reduction in water level (1 or 0, respectively). 
- snow_t: April 1 snow water equivalent (SWE) in year of translocation, measured at Dana Meadows (DAN station).
- snow_t1: April 1 snow water equivalent (SWE) in year following translocation, measured at Dana Meadows (DAN station).
- date: Date of translocation (yyyy-mm-dd).
- year: Year of translocation.
- day: Day of year on which translocation occurred, expressed as number of days since 01-January.  
- order: Order of translocation at the site. 1 = first translocation, 2 = second translocation, etc.
- pit_tag_ref: Unique 9 or 15-digit PIT tag identifier.  
- donor: Unique 5-digit identifier of donor site at which frogs were collected. 
- sex: Sex of translocated frog. 
- length: Snout-vent length of translocated frog, measured at donor site at time of capture and $\leq$ 24 hours before translocation (in millimeters).
- weight: Weight of translocated frog, measured at donor site at time of capture and $\leq$ 24 hours before translocation (in grams).
- bd_load: Bd infection intensity, measured at donor site at time of capture and $\leq$ 24 hours before translocation (ITS1 copies * 80).
- survival: Probability of surviving one year after translocation. 



