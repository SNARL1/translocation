---
title: "Predictors of frog survival following translocations - analyses"
author: "Roland Knapp"
output: html_notebook
---

The goal of the analyses in this notebook is to identify predictors of frog survival following translocation. The analyses are conducted in a Bayesian framework using the R package rstanarm.

## Load packages

```{r load-packages}
library(tidyverse)
# library(brms)
library(rstanarm)
library(bayesplot)
library(tidybayes)
library(loo)
library(broom.mixed)
library(janitor)
```

## Read in frog translocation dataset  
* Read in data, create variables for analysis, standardize continuous variables. 
* arm package used to rescale continuous variables (substract mean, divide by 2 SD), manual centering of binary variables.
```{r read-translocation-data}
d1 <- read_csv(here::here("data", "clean", "frog_translocation_final.csv")) %>% 
  drop_na(bd_load) %>%  # drop xx records from 70xxx where bd_load is NA
  mutate(
    first = if_else(order == 1, 1, 0),
    surv = if_else(survival < 0.5, 0, 1),
    male = if_else(sex == "m", 1, 0),
    elev_lo = if_else(elevation < 3020, 1, 0), # using interval defined by cut_interval, n = 2
    elev_z = arm::rescale(elevation),
    snowt_z = arm::rescale(snow_t),
    snowt1_z = arm::rescale(snow_t1),
    day_z = arm::rescale(day),
    length_z = arm::rescale(length),
    bdload_l = log10(bd_load + 1),
    bdload_z = arm::rescale(bdload_l),
    shore_c = shore - mean(shore),
    male_c = male - mean(male),
    elevlo_c = elev_lo - mean(elev_lo),
    first_c = first - mean(first),
    across(c(shore_c, male_c, elevlo_c, first_c), round, 3), 
    across(c(site_id, shore_c, first_c, donor, male_c, elevlo_c, year), as.factor),
    surv = as.integer(surv))

# Add a descriptive translocation_id
d1 <- d1 %>% 
  distinct(site_id, year) %>% 
  arrange(site_id, year) %>% 
  group_by(site_id) %>% 
  mutate(transno = seq_len(n())) %>% 
  ungroup() %>% 
  unite(translocation_id, c("site_id", "transno"), remove = FALSE) %>% 
  select(-transno) %>% 
  mutate(translocation_id = as.factor(translocation_id)) %>% 
  inner_join(d1, by = c("site_id", "year")) %>% 
  relocate(translocation_id, .after = site_id)
```

## Null values - check

```{r check-null}
d1 %>% summarize(across(everything(), ~ sum(is.na(.))))
```

## Model using non-standardized predictors
### Model specification
```{r}
m1a <- stan_glm(
  surv ~ length + snow_t + snow_t1 + day + bdload_l + elevation + first + male + donor,
  data = d1,
  family = binomial,
  chains = 4, 
  iter = 5000*2,
  cores = 4,
  seed = 84735)
```

### Priors, chain diagnostics, posterior predictive check
```{r}
prior_summary(m1a)

mcmc_trace(m1a, size = 0.1)
mcmc_dens_overlay(m1a)

summary(m1a)

pp_check(m1a, plotfun = "stat") +
    xlab("Frog survival rate")
```
- mcmc diagnostics all look good.
- Posterior predictive distribution implied by regression model closely matches original data (based on mean frog survival).

### Posterior analysis
```{r}
tidy(m1a, conf.int = TRUE, conf.level = 0.90)

mcmc_intervals(m1a, point_est = "median", prob = 0.80, prob_outer = 0.9) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  # add 0-line to accentuate default line
  ggtitle("Model with non-standardized predictors only",
          "Posterior distributions with medians & 90% uncertainty intervals")

mcmc_areas(m1a, area_method = "equal height", prob = 0.90) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with non-standardized predictors only",
          "Posterior distributions with medians & 90% uncertainty intervals")

mean(bayes_R2(m1a))
```
- Using non-standardized predictors makes plot hard to read due to vastly different scales of predictors.  
- Based on 90% uncertainty intervals, important predictors are snow_t1, elevation, first, donor70567, and donor72996.

## Model using standardized predictors
### Model specification
```{r}
m1b <- stan_glm(
  surv ~ length_z + snowt_z + snowt1_z + day_z + bdload_z + elev_z + first_c + male_c + donor,
  data = d1,
  family = binomial,
  chains = 4, 
  iter = 5000*2, 
  cores = 4, 
  seed = 84735)
```

### Priors, chain diagnostics, posterior predictive check
```{r}
prior_summary(m1b)

mcmc_trace(m1b, size = 0.1)
mcmc_dens_overlay(m1a)

summary(m1b)

pp_check(m1b, plotfun = "stat") +
    xlab("Frog survival rate")
```
- mcmc diagnostics all look good.
- Posterior predictive distribution implied by regression model closely matches original data (based on mean frog survival).

### Posterior analysis
```{r}
tidy(m1b, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1b, area_method = "equal height", prob = 0.90) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with standardized predictors only",
          "Posterior distributions with medians & 90% uncertainty intervals")

mean(bayes_R2(m1b))
```
- As expected, using standardized predictors allows easy comparison across predictors. Important predictors are unchanged. 
- Based on 90% uncertainty intervals, important predictors are snow_t1, elevation, first, donor70567, and donor72996.

## Possible grouping structures to add to model
The dataset has three groups: site_id, translocation_id, and donor. Donor site is not suitable as a grouping variable because there are only 3 levels (i.e., site ids), not enough to make this useful. Site_id and translocation_id contain 12 and 24 levels, respectively. Because translocation_id identifies every translocation and site_id contains a collection of 1-4 translocations, translocation_id may provide the best model fit. Including site_id and translocation_id as separate grouping variables in a single model is also worth considering. However, this would require dropping all site ids (4) from the dataset at which only 1 translocation has been conducted (to ensure within-group variation). This would not take full advantage of the dataset so was excluded from further consideration. Going forward, will build 2 models with identical predictors and either site_id or translocation_id as a grouping variables and compare fit using loo. 

## Model using standardized predictors and site_id grouping variable
### Model specification
```{r}
m1f <- stan_glmer(
  surv ~ length_z + snowt_z + snowt1_z + day_z + bdload_z + elev_z + first_c + male_c + donor + (1 | site_id),
  data = d1,
  family = binomial,
  chains = 4, 
  iter = 5000*2, 
  cores = 4,
  seed = 84735)
```

### Priors & chain diagnostics
```{r}
prior_summary(m1f)

b1 <- c("(Intercept)", "length_z", "snowt_z", "snowt1_z", "day_z", "bdload_z", "elev_z", "first_c0.353", "male_c0.548", "donor70567", "donor72996")

mcmc_trace(m1f, size = 0.1, pars = b1)
mcmc_dens_overlay(m1f, pars = b1)

summary(m1f)
```

### Posterior predictive check
```{r}
loo_m1f <- loo(m1f, cores = 4, save_psis = TRUE)
print(loo_m1f)

pp_check(m1f, plotfun = "stat") +
    xlab("Frog survival rate")
```

### Posterior analysis
```{r}
tidy(m1f, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1f, area_method = "equal height", prob = 0.90, pars = b1) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with standardized predictors & site_id as grouping variable",
          "Posterior distributions with medians & 90% uncertainty intervals")

mean(bayes_R2(m1f))

# Frog survival by site_id
mcmc_areas_ridges(m1f, regex_pars = "site_id") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Frog survival for each recipient site_id")
```
- Based on 90% uncertainty intervals, important predictors reduced to elevation and male. 

## Model using standardized predictors and translocation_id grouping variable)
### Model specification
```{r}
m1g <- stan_glmer(
  surv ~ length_z + snowt_z + snowt1_z + day_z + bdload_z + elev_z + first_c + male_c + donor + (1 | translocation_id),
  data = d1,
  family = binomial,
  chains = 4, 
  iter = 5000*2, 
  cores = 4,
  seed = 84735)
```

### Priors & chain diagnostics
```{r}
prior_summary(m1g)

b1 <- c("(Intercept)", "length_z", "snowt_z", "snowt1_z", "day_z", "bdload_z", "elev_z", "first_c0.353", "male_c0.548", "donor70567", "donor72996")

mcmc_trace(m1g, size = 0.1, pars = b1)
mcmc_dens_overlay(m1g, pars = b1)

summary(m1g)
```

### Posterior predictive check
```{r}
loo_m1g <- loo(m1g, cores = 4, save_psis = TRUE)
print(loo_m1g)

pp_check(m1g, plotfun = "stat") +
    xlab("Frog survival rate")
```

### Posterior analysis
```{r}
tidy(m1g, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1g, area_method = "equal height", prob = 0.90, pars = b1) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with standardized predictors & translocation_id as grouping variable",
          "Posterior distributions with medians & 90% uncertainty intervals")

mean(bayes_R2(m1g))

# Frog survival by translocation_id
mcmc_areas_ridges(m1g, regex_pars = "translocation_id") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Frog survival for each translocation_id")
```
- Based on loo, model with translocation_id as grouping variable provides slightly better fit than model with site_id as grouping variable. 
- Based on 90% uncertainty intervals, important predictors are similar to those in model without grouping variable: snowt1_z, elev_z, male_c0.548, donor72996. 

## Calculate posterior classification accuracy
```{r}
# Posterior predictive models for each frog in dataset
set.seed(84735)
survival_predict_1 <- posterior_predict(m1g, newdata = d1)

# Classify frog survival based on mean predicted survival probability
survival_predict_2 <- d1 %>% 
  mutate(survival_prob = colMeans(survival_predict_1),
         survival_class = as.numeric(survival_prob >= 0.5)) %>% 
  select(site_id, translocation_id, year, snowt1_z, elev_z, male_c, donor, surv, survival_prob, survival_class)

# Generate confusion matrix and calculate accuracy
survival_predict_2 %>% 
  tabyl(surv, survival_class) %>% 
  adorn_totals(c("row", "col"))

(471 + 138)/767 # overall_accuracy 
471/533 # true negative rate
138/234 # true positive rate

# Generate confusion matrix using function
set.seed(84735)
classification_summary(m1g, data = d1, cutoff = 0.5)
```
- Specificity or "true negative rate" measures the proportion of Y = 0 observations that are accurately classified (e.g., proportion of frogs correctly identified as not surviving).
- Sensitivity or "true positive rate" measures the proportion of Y = 1 observations that are accurately classified. 

## Posterior predictive models
### Create reduced model containing only important predictors
- Reduced model is helpful because it reduces the number of values that need to be generated for use in predictive models. 
```{r}
m1g_reduce <- stan_glmer(
  surv ~ snowt1_z + elev_z + male_c + donor + (1 | translocation_id),
  data = d1,
  family = binomial,
  chains = 4, 
  iter = 5000*2, 
  cores = 4,
  seed = 84735)
```

### Simulate and plot posterior predictive models & observations
```{r}
m1g_group_means <- d1 %>% 
  group_by(translocation_id) %>% 
  summarize(count = n(), psurv = mean(surv), elev_z = mean(elev_z), snowt1_z = mean(snowt1_z)) %>% 
  mutate(
    male_c = as.factor(0.548), 
    donor = case_when(
      str_detect(translocation_id, "74976") | str_detect(translocation_id, "70556") ~ "70459",
      str_detect(translocation_id, "70413") ~ "70567",
      TRUE ~ "72996")) %>% 
  arrange(psurv)  # to arrange plot values/labels by psurv

predictions_m1g <- posterior_predict(m1g_reduce, newdata = m1g_group_means)

ppc_intervals(
  y = m1g_group_means$psurv,
  yrep = predictions_m1g, 
  prob = 0.5, 
  prob_outer = 0.8) +
ggplot2::scale_x_continuous(
  labels = m1g_group_means$translocation_id,
  breaks = 1:nrow(m1g_group_means)) +
  xaxis_text(angle = 90, vjust = 0.5) +
xlab("Translocation_id")
```
- Uncertainty intervals appear not correct for binomial model, but not sure how to adjust. 
- It appears that the model is doing a good job of predicting survival based on site-level and individual-level characteristics.  
- What explains the low predicted survival at 70370 (both translocations), and high versus low survival at 70550 for 1st and 2nd translocations, respectively? Both sites seem to contain high quality habitat (i.e., high elevation).  
- Estimated survival only for males. Run another set of models for females?  

## TO DO
- Validate priors, tune as necessary. Add final priors to model specification (in case the defaults change).  
- Create plots to show effect of all important variables.  
- When model-building and testing is complete, renumber models in sequence, rerun all code chunks.  
- Create analysis of survival from first translocation at a site as a predictor of survival from subsequent translocations. For this analysis, will need to drop all sites at which only a single translocation was conducted.  















