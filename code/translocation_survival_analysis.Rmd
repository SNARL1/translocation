---
title: "Predictors of frog survival following translocations - analyses"
author: "Roland Knapp"
output: html_notebook
---

The goal of the analyses in this notebook is to identify predictors of frog survival following translocation. The analyses are conducted in a Bayesian framework using the R package rstanarm.

## Load packages

```{r load-packages}
library(tidyverse)
library(brms)
library(rstanarm)
library(bayesplot)
library(tidybayes)
library(loo)
library(broom.mixed)
library(janitor)

source("classification_summary.R")
```

## Read in frog translocation dataset  
* Read in data, create variables for analysis, standardize continuous variables. 
* arm package used to rescale continuous variables (substract mean, divide by 2 SD), manual centering of binary variables.
```{r read-translocation-data}
d1 <- read_csv(here::here("data", "clean", "frog_translocation_final.csv")) %>% 
  drop_na(bd_load) %>%  # drop xx records from 70xxx where bd_load is NA
  mutate(
    first = if_else(order == 1, 1, 0),
    surv = if_else(survival < 0.5, 0, 1),
    male = if_else(sex == "m", 1, 0),
    elev_lo = if_else(elevation < 3020, 1, 0), # using interval defined by cut_interval, n = 2
    elev_z = arm::rescale(elevation),
    snowt_z = arm::rescale(snow_t),
    snowt1_z = arm::rescale(snow_t1),
    day_z = arm::rescale(day),
    length_z = arm::rescale(length),
    bdload_l = log10(bd_load + 1),
    bdload_z = arm::rescale(bdload_l),
    shore_c = shore - mean(shore),
    male_c = male - mean(male),
    elevlo_c = elev_lo - mean(elev_lo),
    first_c = first - mean(first),
    across(c(shore_c, male_c, elevlo_c, first_c), round, 3), 
    across(c(site_id, shore_c, first_c, donor, male_c, elevlo_c, year), as.factor),
    surv = as.integer(surv))

# Add a descriptive translocation_id
d1 <- d1 %>% 
  distinct(site_id, year) %>% 
  arrange(site_id, year) %>% 
  group_by(site_id) %>% 
  mutate(transno = seq_len(n())) %>% 
  ungroup(site_id) %>% 
  unite(translocation_id, c("site_id", "transno"), remove = FALSE) %>% 
  select(-transno) %>% 
  mutate(translocation_id = as.factor(translocation_id)) %>% 
  inner_join(d1, by = c("site_id", "year")) %>% 
  relocate(translocation_id, .after = site_id)
```

## Null values - check

```{r check-null}
d1 %>% summarize(across(everything(), ~ sum(is.na(.))))
```

## Model using non-standardized predictors
### Model specification
```{r}
m1a <- stan_glm(
  surv ~ length + snow_t + snow_t1 + day + bdload_l + elevation + first + male + donor,
  data = d1,
  family = binomial,
  chains = 4, 
  iter = 5000*2,
  cores = 4,
  seed = 84735)
```

### Priors & chain diagnostics
```{r}
prior_summary(m1a)

mcmc_trace(m1a, size = 0.1)
mcmc_dens_overlay(m1a)

summary(m1a)
```
- mcmc diagnostics all look good.

### List model variable names
```{r}
get_variables(m1a)
```

### Posterior predictive check
```{r}
pp_check(m1a, plotfun = "stat") +
    xlab("Frog survival rate")
```
- Posterior predictive distribution implied by regression model closely matches original data (based on mean frog survival).

### Calculate leave-one-out cross-validation (loo)
```{r}
loo_m1a <- loo(m1a, cores = 4, save_psis = TRUE)
print(loo_m1a)
```

### Posterior analysis
```{r}
tidy(m1a, conf.int = TRUE, conf.level = 0.90)

mcmc_intervals(m1a, point_est = "median", prob = 0.80, prob_outer = 0.9) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  # add 0-line to accentuate default line
  ggtitle("Model with non-standardized predictors only",
          "Posterior distributions with medians & 90% uncertainty intervals")

mcmc_areas(m1a, area_method = "equal height", prob = 0.90) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with non-standardized predictors only",
          "Posterior distributions with medians & 90% uncertainty intervals")

mean(bayes_R2(m1a))
```
- Using non-standardized predictors makes plot hard to read due to vastly different scales of predictors.  
- Based on 90% uncertainty intervals, important predictors are snow_t1, elevation, first, donor70567, and donor72996.

## Model using standardized predictors
### Model specification
```{r}
m1b <- stan_glm(
  surv ~ length_z + snowt_z + snowt1_z + day_z + bdload_z + elev_z + first_c + male_c + donor,
  data = d1,
  family = binomial,
  chains = 4, 
  iter = 5000*2, 
  cores = 4, 
  seed = 84735)
```

### Priors, chain diagnostics, posterior predictive check
```{r}
prior_summary(m1b)

mcmc_trace(m1b, size = 0.1)
mcmc_dens_overlay(m1a)

summary(m1b)
```
- mcmc diagnostics all look good.

### List model variable names
```{r}
get_variables(m1b)
```

### Posterior predictive check
```{r}
pp_check(m1b, plotfun = "stat") +
    xlab("Frog survival rate")
```
- Posterior predictive distribution implied by regression model closely matches original data (based on mean frog survival).

### Calculate loo
```{r}
loo_m1b <- loo(m1b, cores = 4, save_psis = TRUE)
print(loo_m1b)
```

### Posterior analysis
```{r}
tidy(m1b, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1b, area_method = "equal height", prob = 0.90) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with standardized predictors only",
          "Posterior distributions with medians & 90% uncertainty intervals")

mean(bayes_R2(m1b))
```
- As expected, using standardized predictors allows easy comparison across predictors. Important predictors are unchanged. 
- Based on 90% uncertainty intervals, important predictors are snow_t1, elevation, first, donor70567, and donor72996.

## Compare models
```{r}
loo_compare(loo_m1a, loo_m1b)
```
- As expected, models with non-standardized and standardized predictor variables have identical predictive accuracy.  

## Possible grouping structures to add to model
The dataset has three groups: site_id, translocation_id, and donor site. Donor site is not suitable as a grouping variable because there are only 3 levels (i.e., site ids), not enough to make this useful. Site_id and translocation_id contain 12 and 24 levels, respectively, making them suitable as grouping variables. Including both site_id and translocation_id as nested grouping variables (i.e., translocations nested within site ids) also seems justified. Having more levels within a group would seem to increase the power to detect effects of predictors. With fewer levels/less variability, effect may be accounted for primarily by grouping variable itself instead of predictor. With only 1-4 translocations per site and only 12 site ids total, it is possible that model with site_id as sole grouping variable and model with site_id and translocation_id as nested grouping variables will attribute more of the variation in frog survival to the grouping variables and less to the predictors. A priori, that would suggest that the model with translocation_id as the grouping variable might be the most useful model structure (assuming that all models have similar posterior predictive accuracy). Lacking any strong rationale for  one model structure over another, built 3 models and compared their posterior predictive accuracy using loo. 

## Model using standardized predictors and site_id grouping variable
### Model specification
```{r}
m1c <- stan_glmer(
  surv ~ length_z + snowt_z + snowt1_z + day_z + bdload_z + elev_z + first_c + male_c + donor + (1 | site_id),
  data = d1,
  family = binomial,
  chains = 4, 
  iter = 5000*2, 
  cores = 4,
  seed = 84735)
```

### Priors & chain diagnostics
```{r}
prior_summary(m1c)

b1 <- c("(Intercept)", "length_z", "snowt_z", "snowt1_z", "day_z", "bdload_z", "elev_z", "first_c0.353", "male_c0.548", "donor70567", "donor72996")

mcmc_trace(m1c, size = 0.1, pars = b1)
mcmc_dens_overlay(m1c, pars = b1)

summary(m1c)
```

### Posterior predictive check
```{r}
pp_check(m1c, plotfun = "stat") +
    xlab("Frog survival rate")
```

### Calculate loo
```{r}
loo_m1c <- loo(m1c, cores = 4, save_psis = TRUE)
print(loo_m1c)
```

### Posterior analysis
```{r}
tidy(m1c, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1c, area_method = "equal height", prob = 0.90, pars = b1) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with standardized predictors & site_id as grouping variable",
          "Posterior distributions with medians & 90% uncertainty intervals")

mean(bayes_R2(m1c))

# Frog survival by site_id
mcmc_areas_ridges(m1c, regex_pars = "site_id") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Frog survival for each recipient site_id")
```
- Based on 90% uncertainty intervals, important predictors reduced to elevation and male. 

## Model using standardized predictors and translocation_id grouping variable)
### Model specification
```{r}
m1d <- stan_glmer(
  surv ~ length_z + snowt_z + snowt1_z + day_z + bdload_z + elev_z + first_c + male_c + donor + (1 | translocation_id),
  data = d1,
  family = binomial,
  chains = 4, 
  iter = 5000*2, 
  cores = 4,
  seed = 84735)
```

### Priors & chain diagnostics
```{r}
prior_summary(m1d)

b1 <- c("(Intercept)", "length_z", "snowt_z", "snowt1_z", "day_z", "bdload_z", "elev_z", "first_c0.353", "male_c0.548", "donor70567", "donor72996")

mcmc_trace(m1d, size = 0.1, pars = b1)
mcmc_dens_overlay(m1d, pars = b1)

summary(m1d)
```

### Posterior predictive check
```{r}
pp_check(m1d, plotfun = "stat") +
    xlab("Frog survival rate")
```

### Calculate loo
```{r}
loo_m1d <- loo(m1d, cores = 4, save_psis = TRUE)
print(loo_m1d)
```

### Posterior analysis
```{r}
tidy(m1d, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1d, area_method = "equal height", prob = 0.90, pars = b1) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with standardized predictors & translocation_id as grouping variable",
          "Posterior distributions with medians & 90% uncertainty intervals")

mean(bayes_R2(m1d))

# Frog survival by translocation_id
mcmc_areas_ridges(m1d, regex_pars = "translocation_id") +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Frog survival for each translocation_id")
```
- Based on loo, model with translocation_id as grouping variable provides slightly better fit than model with site_id as grouping variable. 
- Based on 90% uncertainty intervals, important predictors are similar to those in model without grouping variable: snowt1_z, elev_z, male_c0.548, donor72996. 

## Model using standardized predictors and 2 grouping variables: translocation_id nested within site_id)
### Model specification
```{r}
m1e <- stan_glmer(
  surv ~ length_z + snowt_z + snowt1_z + day_z + bdload_z + elev_z + first_c + male_c + donor + (1 | translocation_id) + (1 | site_id),
  data = d1,
  family = binomial,
  chains = 4, 
  iter = 5000*2, 
  cores = 4,
  seed = 84735)
```

### Priors & chain diagnostics
```{r}
prior_summary(m1e)

b1 <- c("(Intercept)", "length_z", "snowt_z", "snowt1_z", "day_z", "bdload_z", "elev_z", "first_c0.353", "male_c0.548", "donor70567", "donor72996")

mcmc_trace(m1e, size = 0.1, pars = b1)
mcmc_dens_overlay(m1e, pars = b1)

summary(m1e)
```

### Posterior predictive check
```{r}
pp_check(m1e, plotfun = "stat") +
    xlab("Frog survival rate")
```

### Calculate loo
```{r}
loo_m1e <- loo(m1e, cores = 4, save_psis = TRUE)
print(loo_m1e)
```

### Posterior analysis
```{r}
tidy(m1e, conf.int = TRUE, conf.level = 0.90)

mcmc_areas(m1e, area_method = "equal height", prob = 0.90, pars = b1) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Model with standardized predictors & translocation_id as grouping variable",
          "Posterior distributions with medians & 90% uncertainty intervals")

mean(bayes_R2(m1e))

# Frog survival by translocation_id
mcmc_areas_ridges(m1e, regex_pars = ("translocation_id")) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Frog survival for each translocation_id")

# Frog survival by site_id
mcmc_areas_ridges(m1e, regex_pars = ("site_id")) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", lwd = 0.5) +  
  ggtitle("Frog survival for each translocation_id")
```

## Compare 4 models with different grouping structures
```{r}
loo_compare(loo_m1b, loo_m1c, loo_m1d, loo_m1e)
```
- Based on expected log-predictive densities (ELPD), 3 models with grouping variables all have substantially higher posterior predictive accuracy than model without any grouping variables (elpd_diff of m1b is more than 2 SE lower than elpd_diff of m1c: elpd_diff = -18.2 $\pm$ 12.6, 2 SE interval does not overlap 0: -5.6 -- -30.8). 
- 3 models with 1 or more grouping variables are equivalent and have similar posterior predictive accuracy (elpd_diff of m1e and m1d are within 2 SE of elpd_diff of m1c).  
- m1d seems to provide more insight into the effect of the predictors, so chose this model for additional analysis. 

## Additional analysis of model m1d
### Posterior classification accuracy
```{r}
# Posterior predictive models for each frog in dataset
set.seed(84735)
survival_predict_1 <- posterior_predict(m1d, newdata = d1)

# Classify frog survival based on mean predicted survival probability
survival_predict_2 <- d1 %>% 
  mutate(survival_prob = colMeans(survival_predict_1),
         survival_class = as.numeric(survival_prob >= 0.5)) %>% 
  select(site_id, translocation_id, year, snowt1_z, elev_z, male_c, donor, surv, survival_prob, survival_class)

# Generate confusion matrix and calculate accuracy
survival_predict_2 %>% 
  tabyl(surv, survival_class) %>% 
  adorn_totals(c("row", "col"))

(471 + 138)/767 # overall_accuracy 
471/533 # true negative rate
138/234 # true positive rate

# Generate confusion matrix using function
set.seed(84735)
classification_summary(m1d, data = d1, cutoff = 0.5)
```
- Sensitivity or "true positive rate" measures the proportion of Y = 1 observations that are accurately classified.  
- Specificity or "true negative rate" measures the proportion of Y = 0 observations that are accurately classified (i.e., proportion of frogs correctly identified as not surviving).  

### Create reduced model containing only important predictors for subsequent analyses
- Reduced model is helpful because it reduces the number of values used to calculate predictive models. 
```{r}
m1d_reduce <- stan_glmer(
  surv ~ snowt1_z + elev_z + male_c + donor + (1 | translocation_id),
  data = d1,
  family = binomial,
  chains = 4, 
  iter = 5000*2, 
  cores = 4,
  seed = 84735)
```

### Confirm fit of reduced model is comparable to full model
```{r}
loo_m1d_reduce <- loo(m1d, cores = 4, save_psis = TRUE)
print(loo_m1d)

loo_compare(loo_m1d, loo_m1d_reduce)
```

### Simulate and plot posterior predictive models & observations
```{r}
m1d_group_means <- d1 %>% 
  group_by(translocation_id) %>% 
  summarize(count = n(), psurv = mean(surv), elev_z = mean(elev_z), snowt1_z = mean(snowt1_z)) %>% 
  mutate(
    male_c = as.factor(0.548), 
    donor = case_when(
      str_detect(translocation_id, "74976") | str_detect(translocation_id, "70556") ~ "70459",
      str_detect(translocation_id, "70413") ~ "70567",
      TRUE ~ "72996")) %>% 
  arrange(psurv)  # to arrange plot values/labels by psurv

predictions_m1d <- posterior_predict(m1d_reduce, newdata = m1d_group_means)

ppc_intervals(
  y = m1d_group_means$psurv,
  yrep = predictions_m1d, 
  prob = 0.5, 
  prob_outer = 0.8) +
ggplot2::scale_x_continuous(
  labels = m1d_group_means$translocation_id,
  breaks = 1:nrow(m1d_group_means)) +
  xaxis_text(angle = 90, vjust = 0.5) +
xlab("Translocation_id")
```
- Uncertainty intervals appear incorrect for binomial model, but not sure how to adjust.  
- Based on mean values, model does an adequate job of predicting survival based on group-level and individual-level characteristics.  
- What explains the low predicted survival at 70370 (both translocations), and high versus low predicted survival at 70550 for 1st and 2nd translocations, respectively? Both sites seem to contain high quality habitat (i.e., high elevation).  
- The predicted survival is based on assumption that only males are included. Run another set of models for females?  

### Plot posterior plausible relationships between each predictor and the probability of frog survival (conditional effects)
- As described in https://rdrr.io/cran/brms/man/conditional_effects.brmsfit.html, "When creating conditional_effects for a particular predictor (or interaction of two predictors), one has to choose the values of all other predictors to condition on. By default, the mean is used for continuous variables and the reference category is used for factors, but you may change these values via argument conditions. This also has an implication for the points argument: In the created plots, only those points will be shown that correspond to the factor levels actually used in the conditioning, in order not to create the false impression of bad model fit, where it is just due to conditioning on certain factor levels."  
- Using rstanarm, I was unable to do this as I expected to: Start with data = d1 and using "newdata = " to specify that predictions should be based on data in d1_elevz (for example), in which non-plotted continuous predictors are set to the mean value. Not sure if my alternative approach is correct.  
- Approach used: Instead of starting the routine with d1, I started with the new dataset in which all variables except the one of interest were set to mean values (continuous variables) and the reference level (categorical variables). This produced plots/results that were very similar to those produced in brms using the conditional_effects function. 

#### Effect of elevation
```{r}
d1_elevz <- d1 %>% 
  mutate(snowt1_z = mean(snowt1_z), 
         male_c = recode(male_c, "-0.452" = "0.548"),
         donor = recode(donor, "70567" = "70459", "72996" = "70459"))

d1_elevz %>% distinct(snowt1_z, male_c, donor) # ensure variables were set to correct values
  
d1_elevz %>% 
  select(site_id, translocation_id, snowt1_z, elev_z, male_c, donor, surv) %>% 
  add_epred_draws(m1d_reduce, ndraws = 100, re_formula = NA) %>% 
  ggplot(aes(x = elev_z, y = surv)) +
    geom_line(aes(y = .epred, group = .draw), color = "blue", size = 0.2, alpha = 0.5) +
#    geom_point(aes(y = .epred)) +
  labs(x = "Elevation of recipient site (standardized)", y = "Probability of 1-year frog survival")


# d1 %>%  # Test of add_predicted_draws used for similar purpose - unsuccessful
#   select(site_id, translocation_id, snowt1_z, elev_z, male_c, donor, surv) %>% 
#   add_predicted_draws(m1d_reduce, ndraws = 100, re_formula = NA, newdata = d1_elevz) %>% View()
#   ggplot(aes(x = elev_z, y = surv)) +
#     geom_line(aes(y = .epred, group = .draw), color = "blue", size = 0.2, alpha = 0.5) +
#     geom_point(aes(y = .epred)) +
#   labs(x = "Elevation of recipient site (standardized)", y = "Probability of 1-year frog survival")
```

#### Effect of winter severity in year t1
```{r}
d1_snowt1z <- d1 %>% 
  mutate(elev_z = mean(elev_z), 
         male_c = recode(male_c, "-0.452" = "0.548"),
         donor = recode(donor, "70567" = "70459", "72996" = "70459"))

d1_snowt1z %>% distinct(elev_z, male_c, donor) # ensure variables were set to correct values
  
d1_snowt1z %>% 
  select(site_id, translocation_id, snowt1_z, elev_z, male_c, donor, surv) %>% 
  add_epred_draws(m1d_reduce, ndraws = 100, re_formula = NA) %>% 
  ggplot(aes(x = snowt1_z, y = surv)) +
    geom_line(aes(y = .epred, group = .draw), color = "blue", size = 0.2, alpha = 0.5) +
#    geom_point(aes(y = .epred)) +
  labs(x = "Winter severity in year following translocation (standardized)", y = "Probability of 1-year frog survival") 
```

#### Effect of sex
```{r}
d1_malec <- d1 %>% 
  mutate(elev_z = mean(elev_z), 
         snowt1_z = mean(snowt1_z),
         donor = recode(donor, "70567" = "70459", "72996" = "70459"))

d1_malec %>% distinct(elev_z, snowt1_z, donor) # ensure variables were set to correct values
  
d1_malec %>% 
  select(site_id, translocation_id, snowt1_z, elev_z, male_c, donor, surv) %>% 
  add_epred_draws(m1d_reduce, ndraws = 100, re_formula = NA) %>% 
  ggplot(aes(x = male_c, y = surv)) +
    geom_boxplot(aes(y = .epred, x = male_c)) +
#    geom_point(aes(y = .epred)) +
    labs(x = "Sex (centered)", y = "Probability of 1-year frog survival")
```

#### Effect of donor
```{r}
d1_donor <- d1 %>% 
  mutate(elev_z = mean(elev_z), 
         snowt1_z = mean(snowt1_z),
         male_c = recode(male_c, "-0.452" = "0.548"))

d1_donor %>% distinct(elev_z, snowt1_z, male_c) # ensure variables were set to correct values
  
d1_donor %>% 
  select(site_id, translocation_id, snowt1_z, elev_z, male_c, donor, surv) %>% 
  add_epred_draws(m1d_reduce, ndraws = 100, re_formula = NA) %>% 
  ggplot(aes(x = donor, y = surv)) +
    geom_boxplot(aes(y = .epred, x = donor)) +
#    geom_point(aes(y = .epred)) +
    labs(x = "Donor population", y = "Probability of 1-year frog survival")
```

#### Joint effects of elevation and sex
```{r}
d1_elevz_malec <- d1 %>% 
  mutate(snowt1_z = mean(snowt1_z), 
         donor = recode(donor, "70567" = "70459", "72996" = "70459"))

d1_elevz_malec %>% distinct(snowt1_z, donor) # ensure variables were set to correct values
  
pal <- c("#0d0887", "#f89540")
d1_elevz_malec %>% 
  select(site_id, translocation_id, snowt1_z, elev_z, male_c, donor, surv) %>% 
  add_epred_draws(m1d_reduce, ndraws = 100, re_formula = NA) %>% 
  ggplot(aes(x = elev_z, y = surv, color = male_c)) +
    geom_line(aes(y = .epred, group = paste(male_c, .draw)), size = 0.4, alpha = 0.5) +
#    geom_point(aes(y = .epred)) +
    labs(x = "Elevation of recipient site (standardized)", y = "Probability of 1-year frog survival") +
    scale_color_manual(values = pal)  + 
    theme_classic()
```


## For comparison, fit model using brms and conditional_effects function to plot variable-specific effects
### Fit model
```{r}
m1d_reduce_brms <- brm(
  surv ~ snowt1_z + elev_z + male_c + donor + (1 | translocation_id),
  data = d1,
  family = bernoulli(),
  chains = 4, 
  iter = 5000*2, 
  cores = 4,
  seed = 84735)
```

### Plot conditional effects
```{r}
plot(conditional_effects(m1d_reduce_brms, spaghetti = TRUE, mean = TRUE, ndraws = 100), ask = FALSE)
```


## TO DO
- Validate priors, tune as necessary. Add final priors to model specification (in case the defaults change).  
- Check approach to plotting conditional effects.  
- Create analysis in which survival from first translocation to a site is a predictor of survival from subsequent translocations. For this analysis, will need to drop all sites at which only a single translocation was conducted.  
- Try un-standardizing predictor values in conditional-effects plots (and other plots?) to produce more intuitive visualizations.  








