---
title: "Notebook: Predictors of frog survival following translocation"
author: "Roland Knapp"
date: "`r Sys.Date()`"
output:
  github_document: 
    toc: true
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, results='hide')
```

```{r}
library(tidyverse)
```

## Dataset structure

* site_id: site to which frogs were translocated  
* elevation: water body surface elevation above sea level, in meters  
* shore: presence/absence of shore/bank habitat available to frogs in winter (estimated in late-summer)  
* snow_t: snow water content (measured on April 1) in year of translocation  
* snow_t1: snow water content (measured on April) in year following translocation  
* date: date frogs released at recipient site  
* year: year frogs released at recipient site  
* day: day of the year on which frogs were released  
* order: order of translocations to a site, from 1-4. Recoded prior to analysis ("order_f") as 0/1: 0 = first translocation to site; 1 = subsequent translocations  
* donor: site_id from which frogs were collected for translocation  
* pit_tag_ref: pit tag id  
* sex: m or f, recoded for analysis as 0 for males and 1 for females  
* length: frog snout-vent length at release (in mm)  
* weight: frog weight at release (in grams)  
* bd_load: number of ITS copies at release, measured from swab swab collected on capture (as with length and weight)  
* survival: individual-level estimated survival 1 year following translocation, based on cmr surveys conducted for at least two years post-translocation. Prior to analysis, recoded ("surv") as 0/1 (0: survival < 0.5; 1: survival $\geq$ 0.5)

Maximum depth and surface area would seem useful to include, but 74976 is a stream/meadow habitat and as such depth and area at that site are likely not comparable to depth and area at lake habitats.

Frog condition might be problematic because size and residuals are correlated. Specifically, the largest frogs have the largest positive residuals from a weight:length regression line, even after log10 transformation. As such, length and condition are probably not independent.

```{r frog-length-weight-plot}
read_csv(here::here("data", "clean", "frog_translocation_final.csv")) %>% 
ggplot(aes(x = length, y = weight)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = "Length (mm)", 
       y = "Weight (g)")
```

Another consideration when designing the analysis is that there are 12 records in which bd_load is null. Of these, 9 are from 70413 on 2013-07-15, likely due to a rush to get frogs packaged prior to helicopter arrival. 39 frogs were translocated on that date, so plenty of swab results are available to represent that site. Prior to running the analyses, should drop the 12 records where bd_load = NA. If bd_load is not an important predictor, can run analysis (without the bd_load predictor) using the full dataset.

## Exploratory analyses

Exploratory data analyses conducted in translocation_survival_exploratory.Rmd provide several notable insights. 

### Donor site
* 1-year frog survival is highly variable across sites, but highly repeatable within a site. This indicates the importance of including site_id as a group-level effect. It remains unclear whether also including a group effect (year) that identifies each translocation might also be needed (or feasible given relatively small number of translocations per site). 
* Donor site has a strong effect on frog survival, with 70459 > 70567 > 72996. Explored possible effects of bd_load and frog size as drivers of this pattern. Differences in survival between donor sites seem unrelated to bd_load, but appear closely associated with frog size (see sub-bullets below). Whether frog size is the sole driver or is a results of frog size plus other unmeasured donor site attributes (e.g., degree of resistance against Bd infection) remains to be seen. 
  * Minimal differences between donor sites in median bd_load, but slightly higher at 72996. No obvious effect of bd_load on 1-year frog survival. 
  * Strong effect of frog size on 1-year survival, with frogs /> 55 mm having substantially higher 1-year survival. Frogs />60 mm had by far the highest survival. 
  * The effect of frog size on survival was unrelated to bd_load: No relationship between the two variables. 
  * Frog size differs between donor site: 72996 < 70459 = 70567. This partially mirrors the observed differences in survival between sites. 

### Bd load
* Frogs with the highest loads at the time of translocation had the lowest survival. The effect was only evident in the category that included frogs with loads of 56,000--2,100,000 ITS copies. Notable result given that the threshold level of 56,000 is /~ 1 order of magnitude below the 600,000 copies level associated with frog mortality during epizootics. 

### Recipient site characteristics
* **Shore habitat**: The presence of shore habitat substantially increased frog survival. Unknown if this is a direct effect reflecting the importance of this habitat type, or if shore habitat is serving as a proxy for another habitat feature. Association with shore habitat presence/absence and elevation will make it difficult to disentangle these effects. It may only be possible to include one of these two variables in the model. If so, elevation would make the most sense to include. 
* **Elevation**: Strong positive effect on frog survival. 

### Translocation timing
* Day of the year showed no obvious relationship to frog survival. 
* Year was positively associated with survival. This likely is not a direct effect of year, but instead reflects better-informed selection of recipient sites over time that contained high-quality frog habitat. As such, consider not including year in the model. 

### Winter severity
* No obvious relationship between either winter severity in year of translocation or in year following translocation on frog survival. 

### Translocation order
* Frogs in the first cohort translocated to a site generally had higher survival than frogs in subsequent cohorts. However, effect was not particularly strong. 
* It remains unclear what the mechanism is of the slightly higher mortality of later cohorts.

### Frog characteristics
* Frog size had strong effect on 1-year survival. 
* Minimal differences in survival between males and females (slightly higher in males). 


## Model structure

As originally conceived: survival \~ elevation + shore + snow_t + snow_t1 + year + day + order + donor + sex + length + log(bdload) \| site_id

Based on exploratory analyses: survival \~ elevation + snow_t + snow_t1 + day + order + donor + sex + length + log(bdload) \| site_id  

Make pairs plot to identify correlations between predictors (ggpairs from GGally package). 

It may not be possible to include both donor and length in a single model because the distribution of frog lengths is quite different across sites, causing dependency between donor and length. As such, these two variables have the potential to compete for the same variation. Need to look at this more closely, perhaps by plotting frog lengths at each donor site. Also, plot length against survival, grouped by donor.  Are these distributions as donor-specific as they apear to be? Because of the importance of distinguishing frog size effects from other effects associated with donor populations (e.g., inherent differences in Bd susceptibility), may need to explore whether it would be possible to compare the fit of two models, each containing one of these two variables. 

Also need to disentangle elevation from site_id - currently only one elevation per site_id. Try breaking continuous elevation into categories, with > 2 site_ids per category. Hopefully, that will make elevation variable less dependent on site_id. 

Shore and elevation may also be closely associated. Are all sites with shore = 0 at low elevation? If so, may need to only include elevation in model.  

Group-level effects: Numerous levels of structure inherent in the data, including that caused by year, site_id, donor, and translocation id. However, most of these are not sufficiently hierarchical to allow inclusion as a group-level effect. For example, 70413 only received frogs collected from 70567. For year, only a small subset of site ids are represented in each year and the subset changes dramaticall from year to year. Donor and translocation id have even sparser matrices with site_id. As such, site_id is the only reasonable group-level effect to consider for inclusion in model. Related to this, general guidance is that 5 or more levels are generally necessary for a grouping variable to be considered for inclusion as a group-level effect. Models with fewer levels may converge but the group-level variable may have little or no effect. 

Interactions: General guidance is that interactions between the most important predictors should be included in model. 

## Final steps before building model (in analysis Rmd):

* Recode order as 0/1 (instead of 1--4).  
* Recode survival as 0/1 (instead of continuous probability).  
* Recode binary variables as 0/1 indicators: sex (see Gelman reference below).  
* Format some variables as factor: surv, shore, order, donor, sex, site_id, year.  
* Standardize continuous variables: elevation, snow_t, snow_t1, day, length. Possibly standardize log(bd_load) also, but see Gelman for recommendations. Gelman recommends centering by subtracting the mean and standardizing dividing by 2 standard deviations. Centering to a mean of 0 makes interactions more interpretable. Standardizing allows assessment of importance of predictors by comparing regressions coefficients. Dividing by 2 SD puts continuous variables on approximately the same scale as binary (0/1) variables. This is true only if binary predictors have similar number of 0s and 1s. In the current dataset, there is some deviation from 1:1. Sex: female = 428, male = 351; order: 0 = 507, 1 = 272. Binary variables should be centered but not standardized. Variables in need of log-transformation should be transformed and then rescaled, although rescaling will not always be necessary.  

Relevant references are as follows:  

* Gelman 2008: https://doi.org/10.1002/sim.3107  
* Schielzeth 2010: https://doi.org/10.1111/j.2041-210X.2010.00012.x  

## Priors

* For regression coefficients in logistic regression: A recommended weakly informative prior is beta ~ student_t(nu,0,s), where s is chosen to provide weak information on the expected scale, and 3<nu<7.  https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations.  
* Other recommendations in:
  * https://doi.org/10.1111/oik.0598.  
  * Choosing priors in Bayesian ecological models by simulating from the prior predictive distribution.  https://doi.org/10.1002/ecs2.3739

## Results

* Figures showing estimated coefficients from models with and without site_id as group-level effect.  


## Next steps

* Site_id group-level effect largely accounted for differences between donor sites in frog survival, frog size, etc. To provide another assessment of the effect of frog size on survival, create a second model that includes only donor = 72996. Given that there is considerable variation in frog sizes translocated from this site, this might allow an assessment of the effect of frog size without the group-level effect (because there probably aren't enough sites to which frogs from 72996 were translocated) to make site_id a useful group-level effect.  
* To assess within-site association between survival for the first and second translocated cohorts, build another dataset that includes all of those recipient sites for which > 1 translocation was conducted. Include survival from the first translocation as the response variable and survival from the second translocation as a predictor variable. Other predictors could also be included. 


